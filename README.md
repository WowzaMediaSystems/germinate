# Germinator
Rails allows incremental database migrations, but only provides a single seed file (non-incremental) that causes problems when you try to run it during each application deploy.  Germinate provides a process very similar to the Rails database migrations that allows you to ensure that a data seed only gets run once in each environment.  It also provides a way to limit which Rails environments are allowed to run particular seeds, which helps protect data in sensitive environments (e.g. Production)

# License

This Rails Gem is distributed under the MIT Open Source License.  To read more about it view the [MIT-LICENSE](https://github.com/WowzaMediaSystems/germinator/blob/master/MIT-LICENSE) file in the repository.

#### Attribution

This gem was created by:

- Jocko MacGregor
- Wowza Media Systems, Inc.

# Installation

To install the Germinator database table and the db/germinate directory in your Rails application:

##### 1. Add the gem to your gemfile:

```ruby
# myapplication/Gemfile
gem "germinator", github: "WowzaMediaSystems/germinator"
```

##### 2. In the terminal, make sure you're in your application directory:

```bash
$ cd /myapplication
```

##### 3. Run bundle install:

```bash
$ bundle install
```

##### 4. Execute the germinator installer:

```bash
$ rails generate install_germinator
```

You're done!!

# Working with Seeders


##### What is a Seeder?

Everything in the Germinator process revolves around a Seeder file.   These files are very similar to the migration files generated by Rails. By default all Seeder files are located in the germinate folder in your application, located here:

```bash
myapplication/db/germinate
```

Each file in this directory has a common naming convention that combines the timestamp from the time it was created, and a name to use as a reference for "planting" a seed file.  Example:

```bash
20150217100232_example_seeder.rb
```

#### Generating a new Seeder File

To generate a new Seeder file, in your application directory, you generate a germinator and give it a unique (not previously used) camel cased name:

```bash
$ rails generate germinator MyFirstSeeder
```

#### How the Seeder File is constructed

The seeder file is a standard ruby class that inherits the Germinator::Seed class. If you examine a newly generated seed file, the structure will look similar to this.  I've anotated each method with comments to show how they are used:

```ruby
class MyFirstSeederSeed < Germinator::Seed

  def environments
    # This method identifies which environments it is safe to execute this seed file in.
    # There are 4 valid responses:
    #
    # true                    -> Returning true says that this seed file can be run in any environment.
    # "development"           -> Returning a string with the name of one environment limits it execution 
    #                            to that one environment, in all other environments this file will be ignored.
    # ["development", "test"] -> Returning an array of strings limits the seed files execution to only the
    #                            environments named in the array.
    # false                   -> Return false says that this seed file is disabled and should not be executed.
  end

  def germinate
    # This method is executed during germinate rake task.  This method is only ever executed once.  This is modeled 
    # after the database migration "up" method.
    
    # You can put any valid rails commands in this block, or if you want to make the germainte and plant commands
    # execute the same code, you can just call:
    #
    # plant
  end

  def shrivel
    # This method is execute during the shrivel rake task.  This method is only ever executed once. This is modeled
    # after the database migration "down" method.
  end

  def plant
    # This method is executed during the plant rake task.  This method can be executed multiple times from the command
    # line.
    #
    # This command is good for data clean up or repetitive database tasks.
  end

end
```

# Germinating the Database

To run all of the unexecuted Germinator seed files, run the following command from the application directory:

```bash
$ rake db:germinate
```

This will compare the available seed files against the timestamps stored in the `germinator_migrations` table, and run any file that has a timestamp that hasn't been stored in the table.  Files are executed in chronological order, according to their timestamp. Once the file is run, its timestamp is stored in the table.

#### Limiting Germinate Execution

By default, all unexecuted seed files are run by the `db:germinate` task.  If you only want to run a limited number of seeds, you can pass in seed limit value to the rake task.  For instance, if you only want to run the next available seed file, you would do so like this:

```bash
$ rake db:germinate[1]
```

# Shriveling the Database

To reverse the germinate process, you run the shrivel task.  This calls the shrivel command on each previously executed Germinator seed file in reverse-chronological order. To execute the task, run the following command from the application directory:

```bash
$ rake db:shrivel
```

By default this will only shrivel by one file at a time.  Each execution removes the timestamp of the executed file from the `germinator_migrations` table.

#### Executing Shrivel Multiple Times

By default, Shrivel will only execute one file at a time.  To increase the number of files executed during the Shrivel process you can pass in a limit value:

```bash
$ rake db:shrivel[3]
```

This will execute the last three files in reverse chronological order.

#### Shriveling All Files

To shrivel the database for all execute files you can run the following command in the application directory:

```bash
$ rake db:shrivel[0]
```

# Reseeding the Database

To completely reseed the database, you can execute the reseed task like this:

```bash
$ rake db:reseed
```

This executes the shrivel command on all previously executed see files, and then follows that by executing the germinate command on all available files.

#### Limiting the Reseed 

To limit the how many of the files get reseeded, you can set the limit like this:

```bash
$ rake db:reseed[3]
```

This will reseed the last three see files.

# Planting the Database

Germinator allows for a process called Planting.   The `plant` method in the seed file can be executed multiple times.   This can be used as a way to clean or update database records as needed throughout the life of the database.  To execute a plant command you call the plant rake task and pass in the name of the seed file to execute. 

If you have a seed file called `20150217100232_example_seeder.rb` you can execute the plant command like this:

```bash
$ rake db:plant["example_seeder"]
```
